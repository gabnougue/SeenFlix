version: "3.8"

services:
  backend:
    build: ./backend
    container_name: seenflix-backend-dev
    # Utilise nodemon pour le hot-reload
    command: npm run dev
    env_file:
      - .env
    volumes:
      # Monte le code source pour que les changements soient détectés
      - ./backend:/app
      # Préserve les node_modules du conteneur
      - /app/node_modules
      # Persistance de la base de données SQLite (même fichier que prod ou différent selon besoin, ici dev.db)
      - ./backend/prisma/dev.db:/app/prisma/dev.db
    environment:
      - NODE_ENV=development
      - PORT=3000
      - DATABASE_URL=file:./dev.db
    restart: unless-stopped

  frontend:
    # En dev, on utilise l'étape de build (Node)
    build:
      context: ./frontend
      target: build-stage
    container_name: seenflix-frontend-dev
    # Utilise Vite pour le hot-reload sur le port 8081
    command: npm run dev -- --host --port 8081
    volumes:
      # Monte le code source
      - ./frontend:/app
      # Préserve les node_modules
      - /app/node_modules
    ports:
      # Mappe le port 8081 de l'hôte vers le port 8081 du conteneur
      - "8081:8081"
    environment:
      - VITE_API_TARGET=http://backend:3000
    depends_on:
      - backend
    restart: unless-stopped
